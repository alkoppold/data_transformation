---
title: "Task_Force_SpecCurve_Between"
author: "Alina Koppold"
date: "2023-11-08"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(ggplot2)
library(haven)
library(scales)
library(BayesFactor)
library(MASS)
library(patchwork)
```


### Preparation Dataset 1 
```{r data}
# loading the original data 
#X7163CM_8163CM_EDA_ac <- read_sav("data/7163CM_8163CM_EDA_ac.sav")
  
# in long format 
load("./data/long_EDA_merz.Rdata")

# Rename some variables
names(data_long)[grep("Versuchspersonennummer", names(data_long))] <- "id"
names(data_long)[grep("scr", names(data_long))] <- "scr_raw"

# variables of interest
data_long$reinforcement_rate = "62.5"
data_long$n = "97"
data_long$CS_duration = "6s" 
data_long$CS_stimuli = "picture"
data_long$training = "instructed"
data_long$max_us_raw = "1.96"
data_long$max_cs_raw = "1.96"
data_long$dataset= "Merz"

```

```{r ttest-NHST}
# Gather data and delete max amplitude
data <- gather(data_long, key = "approach", value = "value", - c(id, condition, trialnr,stimulus, scr_raw, dataset))
data$approach<- with(data, paste0(approach, value))
colnames(data)[3] = "scr_mean"


res_ttest_means <- data %>% filter(stimulus %in% c('cspe', 'csm')) %>%
  group_by(approach, dataset) %>%
  summarise(scr_mean_csp = mean(scr_mean[stimulus == 'cspe'], na.rm = T),
            scr_mean_csm = mean(scr_mean[stimulus == 'csm'], na.rm = T),
            scr_sd_csp = sd(scr_mean[stimulus == 'cspe'], na.rm = T),
            scr_sd_csm = sd(scr_mean[stimulus == 'csm'], na.rm = T))
  
# t test; select csp and csm 
res_ttest <- data %>% filter(stimulus %in% c('cspe', 'csm')) %>%
  group_by(approach, dataset) %>%
  rstatix::t_test(scr_mean ~ stimulus, data = ., paired = T) 


# effect size (using Hedges G)
res_ttest_g <- data %>% filter(stimulus %in% c('cspe', 'csm')) %>%
  group_by(approach, dataset) %>%
rstatix::cohens_d(scr_mean ~ stimulus, data = .,paired = T,ci = T,hedges.correction = TRUE)

### For positive Cohen's d: convert ESs and CIs to absolute values
res_ttest_g$effsize <- abs(res_ttest_g$effsize)
res_ttest_g$conf.low <- abs(res_ttest_g$conf.low)
res_ttest_g$conf.high <- abs(res_ttest_g$conf.high)

# add index to order by effect size
# we have n + 1 unique approaches
res_ttest_g$approach_num <-  1:nrow(res_ttest_g)
res_ttest_g[order(res_ttest_g$effsize),'approach_eff_order'] <-  1:nrow(res_ttest_g)

### Add columns for transformation (log, sqrt, box cox, z-transformation) and range correction type (none, CS corrected, US corrected)
res_ttest_g$transf_type <- str_split_fixed(res_ttest_g$approach, "_", 3)[,2]
res_ttest_g$rc_type <- str_split_fixed(res_ttest_g$approach, "_", 3)[,3]
res_ttest_g$rc_type[res_ttest_g$rc_type == ""] <- "none"

dataset1= res_ttest_g 

```


### Preparation Dataset 2 B07
# implementation of hedges g missing here 
# define variables of interest 
```{r sanity-check-B07}

# Load data
load("./data/dataSCR_B07.RData")

# Select ACQ and T0
#dataSCR <- dataSCR[which(dataSCR$phase == "acq" & dataSCR$timepoint == "T0"), ]

# Exclude some participants: as Rachel: 10, 81
# and 17 because has one missing trial
id_excl <- c(10, 17, 81)
dataSCR <- dataSCR[!is.element(dataSCR$id, id_excl), ]

# Who has zero responses only? -> range correction does not work!
id_zero_cs <- unique(dataSCR$id[which(dataSCR$scr_max_cs == 0)])
id_zero_us <- unique(dataSCR$id[which(dataSCR$scr_max_us == 0)])

# Exclude these participants: 30, 33, 60, 91
id_excl_zero <- c(30, 33, 60, 91)
dataSCR <- dataSCR[!is.element(dataSCR$id, id_excl_zero), ]


# Select columns
#dataSCR <- dataSCR[ ,c("id","cs_time","cs","raw.ampl")]

# Rename some variables
#names(dataSCR)[grep("raw.ampl", names(dataSCR))] <- "scr_raw"
names(dataSCR)[grep("stim_type", names(dataSCR))] <- "cs"
names(dataSCR)[grep("trial", names(dataSCR))] <- "trialnr"

# variables of interest
dataSCR$reinforcement_rate = "100"
dataSCR$n = "113"
dataSCR$CS_duration = "6s" 
dataSCR$CS_stimuli = "picture"
dataSCR$training = "uninstructed"
dataSCR$max_us_raw = "1.49" 
dataSCR$max_cs_raw = "0.89"
dataSCR$dataset = "B07"


```

```{r ttest-NHST}

# Gather data and delete max amplitude
data <- gather(dataSCR, key = "approach", value = "value", - c(id, cs, trialnr, scr_raw,dataset))
data$approach<- with(data, paste0(approach, value))
colnames(data)[4] = "scr_mean"

res_ttest_means <- data %>% filter(cs %in% c('CS_P', 'CS_M')) %>%
  group_by(approach, dataset) %>%
  summarise(scr_mean_csp = mean(scr_mean[cs== 'CS_P'], na.rm = T),
            scr_mean_CS_M = mean(scr_mean[cs== 'CS_M'], na.rm = T),
            scr_sd_csp = sd(scr_mean[cs== 'CS_P'], na.rm = T),
            scr_sd_CS_M = sd(scr_mean[cs== 'CS_M'], na.rm = T))
  
# t test; select CS_P and CS_M 
res_ttest <- data %>% filter(cs %in% c('CS_P', 'CS_M')) %>%
  group_by(approach, dataset) %>%
  rstatix::t_test(scr_mean ~ cs, data = ., paired = T) 

# effect size
res_ttest_d <- data %>% filter(cs %in% c('CS_P', 'CS_M')) %>%
  group_by(approach, dataset) %>%
rstatix::cohens_d(scr_mean ~ cs, data = .,paired = T,ci = T)

### For positive Cohen's d: convert ESs and CIs to absolute values
res_ttest_d$effsize <- abs(res_ttest_d$effsize)
res_ttest_d$conf.low <- abs(res_ttest_d$conf.low)
res_ttest_d$conf.high <- abs(res_ttest_d$conf.high)

# add index to order by effect size
# we have n + 1 unique approaches
res_ttest_d$approach_num <-  1:nrow(res_ttest_d)
res_ttest_d[order(res_ttest_d$effsize),'approach_eff_order'] <-  1:nrow(res_ttest_d)

### Add columns for transformation (log, sqrt, box cox, z-transformation) and range correction type (none, CS corrected, US corrected)
res_ttest_d$transf_type <- str_split_fixed(res_ttest_d$approach, "_", 3)[,2]
res_ttest_d$rc_type <- str_split_fixed(res_ttest_d$approach, "_", 3)[,3]
res_ttest_d$rc_type[res_ttest_d$rc_type == ""] <- "none"

dataset2= res_ttest_d 

```


```{r}
merged_datasets = rbind(dataset1, dataset2)
```

# Plot needs to be adjusted

```{r plot-curves-NHST}

# set colors for plotting
# set colors
clrs <- c("#D1D646",
          "orange",
"#F97068",
"#57C4E5",
"blue",
"#17A398",
"#A05C7B",
"#435058")
barplot(1:6, col=clrs)
# set sizes 
size_point <- 5  # lines in categories under spec curve
size_text  <- 12 # text and ticks on x and y axis

fig_w <- 10
fig_h <- 7
fig_res <- 300

# labels
x_lab <- 'Approach number ordered by effect size'
y_lab <- 'Effect size (Cohen\'s D)'

# order by effect size
# colored by approach
p1 <- merged_datasets %>%
  ggplot(aes(x = approach_eff_order, y = effsize, color = dataset)) +
  geom_point() +
  geom_errorbar(aes(ymin = conf.low, ymax = conf.high)) +
#  scale_color_manual(name = 'Transformation', values = clrs[c(1:5)], labels = c("box cox", "log-transformed", "none", "square-root", "z-transformed")) +
 # scale_x_continuous(breaks = c(1:15), labels = c(1:15)) +
  theme_classic() +
  theme(text = element_text(size=size_text),
        legend.position = 'top') +
  xlab(x_lab) +
  ylab(y_lab) + 
  guides(color = guide_legend(nrow = 1))


# plot specifications of parameters
s1 <- ggplot(merged_datasets, aes(x = approach_eff_order, y = transf_type)) +
  geom_point(shape = '|', size = size_point) +
   #scale_color_manual(values = rep('black', length(levels(res_ttest_d$approach)) )) +
  scale_y_discrete(name = 'Dataset') +
    #scale_x_continuous(breaks = c(1:15), labels = c(1:15)) +
  theme(axis.text.x = element_blank(),
        axis.title.x = element_blank(), 
        axis.ticks.x = element_blank(),
        panel.background = element_blank(),
        legend.position = 'none') +
  theme(text = element_text(size=size_text)) 
s1

# Combine plots

plot_spec_NHST <- p1 / s1
plot_spec_NHST

```
